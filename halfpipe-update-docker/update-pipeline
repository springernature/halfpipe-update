#!/usr/bin/env bash
set -euo pipefail
CONCOURSE_URL="https://concourse.halfpipe.io"

echo "* Halfpipe manifest:"
[[ -f .halfpipe.io ]] && cat .halfpipe.io || cat .halfpipe.io.yml

echo
echo "* STEP 1/6: Updating fly to latest version"
fly -t ci sync

echo
echo "* STEP 2/6: Updating halfpipe to latest version"
halfpipe sync
echo

echo
echo "* STEP 3/5: Logging into concourse"
fly -t ${CONCOURSE_TEAM} login -c ${CONCOURSE_URL} -n ${CONCOURSE_TEAM} -u ${CONCOURSE_USERNAME} -p ${CONCOURSE_PASSWORD}

echo
echo "* STEP 4/6: Check pipeline exists named ${PIPELINE_NAME}"
# exits -1 if pipeline not found. We only want to update an existing pipeine, not create a new one.
fly -t ${CONCOURSE_TEAM} builds -p ${PIPELINE_NAME} -c 1

echo
echo "* STEP 5/6: Disable all existing versions"
AUTH="Authorization: Bearer$(grep 'value: ' ~/.flyrc | cut -d: -f2)"
VERSION_URL="${CONCOURSE_URL}/api/v1/teams/${CONCOURSE_TEAM}/pipelines/${PIPELINE_NAME}/resources/version/versions"
VERSION_IDS=$(curl -sSH "${AUTH}" ${VERSION_URL} | jq -r 'map(select(.enabled)) | .[1:][].id')
for ID in $VERSION_IDS; do
  echo "disabling version id ${ID}"
  curl -sSH "${AUTH}" -X PUT ${VERSION_URL}/${ID}/disable
done

echo
echo "* STEP 6/6: Updating pipeline"
halfpipe upload -n

echo
echo "* Finished"
